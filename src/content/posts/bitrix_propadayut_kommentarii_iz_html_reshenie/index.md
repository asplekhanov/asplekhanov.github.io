---
title: "1C-Битрикс. Пропадают комментарии из html: решение"
published: 2024-03-22
description: "Если Вы столкнулись с проблемой когда при добавлении комментария или при пагинации комментариев из html пропадают комментарии, то данная статья может Вам помочь."
image: "https://dzen.ru/lz5XeGt8f/CJwD99250/296fedJV/SSA4hgKsGxU8yGJOu1X-C3RJ-a_VO4GobSuyYSpVf730YuAleft3DbPt4x5TarYEBiWZaC_XmT_1fnG2n3bH8X0ECdPmTesUeckBqv8xfg-USTlqAD_0mRlP8-RPQU4ZNFcz4cg7c-hWywOOU-tE9qQUfi6NRP7ooqy0Yh9mZjUpMspHpGpKdh7pQU9LwQ_aRkup_Db6Ec2OaiUBOzYIHhbhI0Sp2fB5lbnESad_VecWpE1tXMVs-PM_dNDPJEG3G1IJ4qUoWYTeamFsGTPfC0cbiW5mGPI-Luq28FsnuG62oOE3SmpDqueL1btGvpQ35iR8_iw3PShgTzdS7EZSdltDKMI22XvXT8mSLTggLwnGK0otZRhA_g2bt8IJJwu8h5KThwtboQmF6bb65d9EddSEr02e905YcT41M451o9dK4dlDVrgZl8wrYV2oUG8qJAurHUc54W0tqsTjSNSb3Hbxo2epikK6B4gmeuaOd0fUlIzdPQSMiqNMRgGuJ9HnWPAK0bSqOCbOefFuGtIc6Oe6CE21ObF9vunF0krnK-8XYMCFSEsSWKQbZvgn7FRW1NVsbx2kfXtSzkQTrifCphsz2PNHG4oGjEijPgsgnFoEiXoMNdphPd1a16IalJvcxMEjd6nY4HjG6CQK5a_GpXeETq4PdWxKcazGQB4EMEVLIdvzlpirxI_aAJ8L4n1pVUvrb9UYY_wsanfDavVKD9QhctUYGQPp5MjX6iSOddTFF2ysXwf-mCD-JqCt1yK2y_Bq8tT6iEceCbEfiTPcO5QIC82leoHs7xuGQhtFecy1kDC0aylQibR6dbumnPQ29qUMjm-lLSnzfUTQH8eB5QlgO-D3aJtFHZtCD2kzPGpEC1vcd-nBzB-KVRA45an9RbAS9ggZgGnGaEeLl7wGRGSU3K8_hb0aYJ4nc4w2o5Sqw-uDRLnbRJxJYG6ZYW1ZhPgpv1d60J8OqoWQazU7XPciQMQ6SFCbpfn26EfP1lYEJl-tX8Wv29K8RbKMB4LFWRJrwzfYeEUOO9Lf2nEMG_cYO38F2YCs7vtlkyi1CGzHcQEnSIoQ-LYpZTpkzyWWN1asffyVDAqCTqSy_-cDxjohmjHmqZsUzGnyffhSvehFiHssdkuiHx0a1nA5B6svVqAxtig4IHrVObR459_kRwaGDM_dNZ9KwbznQQ_VEUaIkrjDxVu4BwwIg16bAT_IRQpIPecJAC6-K8exiNbaXTRyU0XLSVMYR5nFyjfclpYkhpzcLdV-GbDd1zN-FZFESBIIEMZJujY_2xN-uxJ_yhYr2j4XuTE873plkNtXqR33ETJEe6twuBU454slvOY35lSe7Y7nLWuCrTQx3EYQputyKpP3CLlkD5kwnughzqmkuCmuJ6gTLdzLtcN5dwjvFNAzRyirkdp3mAX4RUxmB8WULS4fls3rcy7kE311g5UIkCmQJJnaJq4KAT06gV955ok6vWb48J2sOoWw-XaLHDRAITWICSNadAq0yfV-BSUFNDyP3wU-OmMcF6FPlQNHWXGLQfX6aoQdSeLeuNNdCJc5CJ1XC6LeTrikMPgm6Y42gGG1udpwenfoFjrnjcW1xFTeL560_lrij_ZhfdXyNKih-WI3yGokjCuC3jjjThuluJivZAiy7i2olLEIhlvMdxFA50qr0tpXGqaq1c0FR_eWvm7d5bw7kn3Wk8ylgFZpMYtTBQlLR247oJ1IEf6IBCk4rgeoAS7MaZQCyZZbfsaBYtV4CiDaFuqECiTexbQGtBy9jDSd2HDu1bNsJxI2-2Mak7QaKEZPqiPdGuBfO-SqSx1XanPeTKoUQ6lFGQyW4oC0WShxCFQKRnvH3qWkdjctD5_nXkoxfsWjnncT1Bhwa4OG6opGzDtyLplQjcvVi9gMtGggPCxaFaD4t5rOZNJBF3v64duFq9Wbxm6WFeenz04_1X3Z0J6WcUxE00cbYVjTJcjbFOy4QG4bY"
tags: ["bitrix", "comments", "решение"]
category: 1C-Битрикс
draft: false
---

> Источник изображения обложки: [Source](https://static15.tgcnt.ru/posts/_0/b7/b75e21624a1e17b7d3794605c63ef238.jpg)

:::tip[Информация]
Форк статьи с [Dzen](https://dzen.ru/a/Zf1CS5LdJ2P9oKsb?share_to=link)
:::

Если Вы столкнулись с проблемой когда при добавлении комментария или при пагинации комментариев из html пропадают комментарии, то данная статья может Вам помочь.

## Описание "бага"
При разработке раздела для сайта столкнулся с проблемой: "На странице со статьей (конкретно Wiki-страница) есть компонент `WIKI.DISCUSSION`.

> WIKI.DISCUSSION - отвечает за вывод комментариев к странице, для вывода комментариев компонент использует `FORUM.TOPIC.REVIEWS`.

При открытии страницы комментарии подгружаются, но при добавлении нового комментария "отрисованные" комментарии стираются из html страницы. Такая же ситуация и при пагинации комментариев. Но если мы разлогинимся на сайте, то все работает корректно.

![Вывод комментариев](https://avatars.dzeninfra.ru/get-zen_doc/271828/pub_65fd424b92dd2763fda0ab1b_65fd4793b81c731058bea7e1/scale_2400)
> Вывод комментариев

![Переход на вторую страницу с комментариями](https://avatars.dzeninfra.ru/get-zen_doc/271828/pub_65fd424b92dd2763fda0ab1b_65fd479bfa9e547108b4c6d2/scale_2400)
> Переход на вторую страницу с комментариями

## Решение
В ходе "раскопок" выяснил, что проблема заключается в **парсинге html**! Зачем в Битрикс используют парсинг html страницы - неясно, но это так.

Парсинг происходит в файле **component_epilog.php** шаблона компонента `FORUM.TOPIC.REVIEWS` с использованием `CForumSimpleHTMLParser()`. Документации по `CForumSimpleHTMLParser()` у Битрикса нет (или я не нашел), поэтому для решения проблемы заменим его на свой парсер.

В качестве парсера я буду использовать `SimpleHTML DOM`, он идеально подходит для этого. Скачиваем библиотеку и располагаем файл `simple_html_dom.php` по пути:
```
local/
└── php_interface/
    └── lib/
        └── simple_html_dom.php
```

Теперь немного модифицируем файл `component_epilog.php`:

1. Подключим библиотеку:
```php
require_once($_SERVER ["DOCUMENT_ROOT"]."/local/php_interface/lib/simple_html_dom.php");
```
2. Инициализируем:
```php
$html = new simple_html_dom();
```
3. Загрузим html:
```php
$html->load($response);
```
4. Найдем блочный элемент `<div>` содержащий список комментариев. Переберем массив комментариев и запишем в строку:
```php
foreach ( $html->find('div[data-bx-role=messages]') as $article )
{
    $messages = $messages . $article;
}
```
5. Произведем замену в массиве `$JSResult["data"]`: `'messages' => $messages,`

Если все сделано правильно работа комментариев восстановится.

Готовый файл `component_epilog.php` можно скачать на [boosty.to](https://dzen.ru/away?to=https%3A%2F%2Fboosty.to%2Fgskie%2Fposts%2F8cb5754a-dc33-4d43-8554-88e34c69135f%3Fshare%3Dpost_link)
