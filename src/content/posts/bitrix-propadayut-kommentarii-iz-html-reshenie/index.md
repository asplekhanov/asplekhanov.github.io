---
title: "1C-Битрикс. Пропадают комментарии из html: решение"
published: 2024-03-22
description: "Если Вы столкнулись с проблемой когда при добавлении комментария или при пагинации комментариев из html пропадают комментарии, то данная статья может Вам помочь."
image: "https://static15.tgcnt.ru/posts/_0/b7/b75e21624a1e17b7d3794605c63ef238.jpg"
tags: ["bitrix", "comments", "решение"]
category: 1C-Битрикс
draft: false
---

> Источник изображения обложки: [Source](https://static15.tgcnt.ru/posts/_0/b7/b75e21624a1e17b7d3794605c63ef238.jpg)

:::tip[Информация]
Форк статьи с [Dzen](https://dzen.ru/a/Zf1CS5LdJ2P9oKsb?share_to=link)
:::

Если Вы столкнулись с проблемой когда при добавлении комментария или при пагинации комментариев из html пропадают комментарии, то данная статья может Вам помочь.

## Описание "бага"
При разработке раздела для сайта столкнулся с проблемой: "На странице со статьей (конкретно Wiki-страница) есть компонент `WIKI.DISCUSSION`.

> WIKI.DISCUSSION - отвечает за вывод комментариев к странице, для вывода комментариев компонент использует `FORUM.TOPIC.REVIEWS`.

При открытии страницы комментарии подгружаются, но при добавлении нового комментария "отрисованные" комментарии стираются из html страницы. Такая же ситуация и при пагинации комментариев. Но если мы разлогинимся на сайте, то все работает корректно.

![Вывод комментариев](https://avatars.dzeninfra.ru/get-zen_doc/271828/pub_65fd424b92dd2763fda0ab1b_65fd4793b81c731058bea7e1/scale_2400)
> Вывод комментариев

![Переход на вторую страницу с комментариями](https://avatars.dzeninfra.ru/get-zen_doc/271828/pub_65fd424b92dd2763fda0ab1b_65fd479bfa9e547108b4c6d2/scale_2400)
> Переход на вторую страницу с комментариями

## Решение
В ходе "раскопок" выяснил, что проблема заключается в **парсинге html**! Зачем в Битрикс используют парсинг html страницы - неясно, но это так.

Парсинг происходит в файле **component_epilog.php** шаблона компонента `FORUM.TOPIC.REVIEWS` с использованием `CForumSimpleHTMLParser()`. Документации по `CForumSimpleHTMLParser()` у Битрикса нет (или я не нашел), поэтому для решения проблемы заменим его на свой парсер.

В качестве парсера я буду использовать `SimpleHTML DOM`, он идеально подходит для этого. Скачиваем библиотеку и располагаем файл `simple_html_dom.php` по пути:
```
local/
└── php_interface/
    └── lib/
        └── simple_html_dom.php
```

Теперь немного модифицируем файл `component_epilog.php`:

1. Подключим библиотеку:
```php
require_once($_SERVER ["DOCUMENT_ROOT"]."/local/php_interface/lib/simple_html_dom.php");
```
2. Инициализируем:
```php
$html = new simple_html_dom();
```
3. Загрузим html:
```php
$html->load($response);
```
4. Найдем блочный элемент `<div>` содержащий список комментариев. Переберем массив комментариев и запишем в строку:
```php
foreach ( $html->find('div[data-bx-role=messages]') as $article )
{
    $messages = $messages . $article;
}
```
5. Произведем замену в массиве `$JSResult["data"]`: `'messages' => $messages,`

Если все сделано правильно работа комментариев восстановится.

Готовый файл `component_epilog.php` можно скачать на [boosty.to](https://dzen.ru/away?to=https%3A%2F%2Fboosty.to%2Fgskie%2Fposts%2F8cb5754a-dc33-4d43-8554-88e34c69135f%3Fshare%3Dpost_link)
